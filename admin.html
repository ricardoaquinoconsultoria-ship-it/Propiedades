<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administraci√≥n</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Tus estilos actuales aqu√≠ (sin cambios) */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #2563eb; --primary-dark: #1d4ed8; --secondary: #64748b; --accent: #f59e0b;
            --danger: #dc2626; --success: #16a34a; --background: #f8fafc; --surface: #ffffff;
            --text: #1e293b; --text-light: #64748b; --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        body { font-family: 'Inter', sans-serif; line-height: 1.6; color: var(--text); background: var(--background); }
        .hidden { display: none !important; }
        
        /* ... (mant√©n todos tus estilos actuales) ... */
        
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Tu HTML actual del admin -->
        <header class="admin-header">
            <h1>‚öôÔ∏è Panel de Administraci√≥n</h1>
            <nav>
                <a href="./" class="btn-store">üè† Ver Cat√°logo</a>
                <button id="logoutBtn" class="btn-logout">üö™ Cerrar Sesi√≥n</button>
            </nav>
        </header>

        <div class="admin-layout">
            <aside class="sidebar">
                <ul class="sidebar-menu">
                    <li><a href="#dashboard" class="active">üìä Panel</a></li>
                    <li><a href="#properties">üè† Gestionar Propiedades</a></li>
                    <li><a href="#add-property">‚ûï Agregar Propiedad</a></li>
                </ul>
            </aside>

            <main class="admin-main">
                <section id="dashboard" class="admin-section">
                    <h2>üìä Panel</h2>
                    <div class="stats-grid">
                        <div class="stat-card"><h3 id="totalProperties">0</h3><p>Total Propiedades</p></div>
                        <div class="stat-card"><h3 id="availableProperties">0</h3><p>Disponibles</p></div>
                        <div class="stat-card"><h3 id="houseCount">0</h3><p>Casas</p></div>
                        <div class="stat-card"><h3 id="apartmentCount">0</h3><p>Apartamentos</p></div>
                    </div>
                </section>

                <section id="properties" class="admin-section hidden">
                    <h2>üè† Gestionar Propiedades</h2>
                    <div class="properties-list" id="propertiesList">
                        <div class="loading-spinner"></div>
                        <p style="text-align: center;">Cargando propiedades...</p>
                    </div>
                </section>

                <section id="add-property" class="admin-section hidden">
                    <h2>‚ûï Agregar Nueva Propiedad</h2>
                    <form id="propertyForm" class="property-form">
                        <div class="form-section">
                            <h3>üìù Informaci√≥n B√°sica</h3>
                            <div class="form-group">
                                <label for="propertyTitle" class="required-field">T√≠tulo de la Propiedad:</label>
                                <input type="text" id="propertyTitle" placeholder="Ej: Casa moderna en zona residencial" required>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="propertyType" class="required-field">Tipo de Propiedad:</label>
                                    <select id="propertyType" required>
                                        <option value="">Seleccionar tipo</option>
                                        <option value="casa">Casa</option>
                                        <option value="apartamento">Apartamento</option>
                                        <option value="oficina">Oficina</option>
                                        <option value="solar">Solar</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="propertyPrice" class="required-field">Precio (USD):</label>
                                    <input type="number" id="propertyPrice" placeholder="Ej: 150000" required min="1">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="propertyDescription" class="required-field">Descripci√≥n:</label>
                                <textarea id="propertyDescription" placeholder="Describe la propiedad..." rows="4" required></textarea>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üè† Caracter√≠sticas</h3>
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="propertyBedrooms">Habitaciones:</label>
                                    <input type="number" id="propertyBedrooms" value="0" min="0" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label for="propertyBathrooms">Ba√±os:</label>
                                    <input type="number" id="propertyBathrooms" value="0" min="0" placeholder="0">
                                </div>
                                <div class="form-group">
                                    <label for="propertyArea" class="required-field">√Årea (m¬≤):</label>
                                    <input type="number" id="propertyArea" placeholder="Ej: 120" required min="1">
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="propertyParking"><label for="propertyParking">Estacionamiento</label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="propertyPool"><label for="propertyPool">Piscina</label>
                                </div>
                                <div class="form-group checkbox-group">
                                    <input type="checkbox" id="propertyGarden"><label for="propertyGarden">Jard√≠n</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üìç Ubicaci√≥n en el Mapa</h3>
                            <div class="form-group">
                                <label for="propertyAddress" class="required-field">Direcci√≥n Completa:</label>
                                <input type="text" id="propertyAddress" placeholder="Ej: Calle Principal #123, Ciudad" required>
                            </div>
                            <div class="map-selector">
                                <p>Haz clic en el mapa para seleccionar la ubicaci√≥n:</p>
                                <div id="locationMap"></div>
                                <div class="coordinates-display">
                                    <span>Coordenadas seleccionadas:</span>
                                    <span id="selectedCoordinates">Lat: 18.7357, Lng: -70.1627</span>
                                </div>
                                <input type="hidden" id="propertyLat" value="18.7357">
                                <input type="hidden" id="propertyLng" value="-70.1627">
                            </div>
                        </div>

                        <div class="form-section">
                            <h3>üñºÔ∏è URLs de Im√°genes (Una por l√≠nea)</h3>
                            <div class="form-group">
                                <label for="imageUrls" class="required-field">URLs de Im√°genes:</label>
                                <textarea id="imageUrls" placeholder="https://ejemplo.com/imagen1.jpg&#10;https://ejemplo.com/imagen2.jpg&#10;https://ejemplo.com/imagen3.jpg" rows="4" required></textarea>
                                <small style="color: var(--text-light);">Ingresa una URL por l√≠nea. M√°ximo 5 im√°genes.</small>
                            </div>
                            <div class="image-preview" id="imagePreview"></div>
                        </div>

                        <button type="submit" class="btn-primary btn-submit">
                            <span id="submitText">üè† Agregar Propiedad</span>
                            <span id="submitLoading" class="hidden loading-spinner"></span>
                        </button>
                    </form>
                </section>
            </main>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // CONFIGURACI√ìN SUPABASE
        const SUPABASE_URL = 'https://vbimfwzxdafuqexsnvso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiaW1md3p4ZGFmdXFleHNudnNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTY4NDksImV4cCI6MjA3OTMzMjg0OX0.8ergS1GXQm6L0Om6AZReeTK0e3Q81k-UQSVJAu3xMNQ';
        
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        class AdminManager {
            constructor() {
                this.properties = [];
                this.locationMap = null;
                this.locationMarker = null;
                this.editingProperty = null;
                this.isLoading = false;
            }

            async init() {
                await this.setupEventListeners();
                await this.initializeLocationMap();
                await this.loadPropertiesFromSupabase();
            }

            async loadPropertiesFromSupabase() {
                try {
                    const { data: properties, error } = await window.supabase
                        .from('properties')
                        .select('*')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    this.properties = properties || [];
                    this.updateDashboard();
                    this.renderPropertiesList();
                    
                } catch (error) {
                    console.error('Error cargando propiedades:', error);
                    alert('‚ùå Error cargando propiedades: ' + error.message);
                }
            }

            setupEventListeners() {
                // Navegaci√≥n
                document.querySelectorAll('.sidebar-menu a').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const target = link.getAttribute('href').substring(1);
                        this.showSection(target);
                        document.querySelectorAll('.sidebar-menu a').forEach(l => l.classList.remove('active'));
                        link.classList.add('active');
                    });
                });

                // Formulario
                document.getElementById('propertyForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    if (this.editingProperty) {
                        this.handleUpdateProperty(this.editingProperty.id);
                    } else {
                        this.handleAddProperty();
                    }
                });

                // Cerrar sesi√≥n
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                        window.location.href = './';
                    }
                });

                // Preview de im√°genes cuando se escriben URLs
                document.getElementById('imageUrls').addEventListener('input', (e) => {
                    this.updateImagePreviewFromUrls(e.target.value);
                });
            }

            showSection(sectionId) {
                document.querySelectorAll('.admin-section').forEach(section => {
                    section.classList.add('hidden');
                });
                const targetSection = document.getElementById(sectionId);
                if (targetSection) targetSection.classList.remove('hidden');
            }

            async handleAddProperty() {
                if (this.isLoading) return;
                
                try {
                    this.isLoading = true;
                    this.setSubmitButtonLoading(true);

                    const formData = this.getFormData();
                    if (!this.validateForm(formData)) return;

                    const { data, error } = await window.supabase
                        .from('properties')
                        .insert([formData])
                        .select();

                    if (error) throw error;

                    alert('‚úÖ Propiedad agregada exitosamente!');
                    await this.loadPropertiesFromSupabase();
                    this.resetForm();
                    this.showSection('properties');
                    
                } catch (error) {
                    console.error('Error:', error);
                    alert('‚ùå Error: ' + error.message);
                } finally {
                    this.isLoading = false;
                    this.setSubmitButtonLoading(false);
                }
            }

            getFormData() {
                const imageUrls = this.getValidImageUrls();
                
                return {
                    title: document.getElementById('propertyTitle').value.trim(),
                    type: document.getElementById('propertyType').value,
                    price: parseFloat(document.getElementById('propertyPrice').value) || 0,
                    description: document.getElementById('propertyDescription').value.trim(),
                    location: {
                        address: document.getElementById('propertyAddress').value.trim(),
                        lat: parseFloat(document.getElementById('propertyLat').value) || 18.7357,
                        lng: parseFloat(document.getElementById('propertyLng').value) || -70.1627
                    },
                    characteristics: {
                        bedrooms: parseInt(document.getElementById('propertyBedrooms').value) || 0,
                        bathrooms: parseInt(document.getElementById('propertyBathrooms').value) || 0,
                        area: parseInt(document.getElementById('propertyArea').value) || 100,
                        parking: document.getElementById('propertyParking').checked || false,
                        pool: document.getElementById('propertyPool').checked || false,
                        garden: document.getElementById('propertyGarden').checked || false
                    },
                    status: 'disponible',
                    images: imageUrls,
                    created_at: new Date().toISOString()
                };
            }

            getValidImageUrls() {
                const urlsText = document.getElementById('imageUrls').value.trim();
                if (!urlsText) return [];
                
                return urlsText
                    .split('\n')
                    .map(url => url.trim())
                    .filter(url => url && this.isValidImageUrl(url))
                    .slice(0, 5); // M√°ximo 5 im√°genes
            }

            isValidImageUrl(url) {
                // Validaci√≥n b√°sica de URL
                try {
                    new URL(url);
                    return url.match(/\.(jpeg|jpg|gif|png|webp)$/i) !== null;
                } catch (_) {
                    return false;
                }
            }

            updateImagePreviewFromUrls(urlsText) {
                const validUrls = this.getValidImageUrls();
                const previewContainer = document.getElementById('imagePreview');
                
                previewContainer.innerHTML = validUrls.map((url, index) => `
                    <div class="preview-item">
                        <img src="${url}" alt="Preview ${index + 1}" loading="lazy" onerror="this.style.display='none'">
                        <span class="image-number">${index + 1}</span>
                    </div>
                `).join('');
            }

            validateForm(formData) {
                const required = [
                    { field: formData.title, name: 't√≠tulo', element: 'propertyTitle' },
                    { field: formData.type, name: 'tipo', element: 'propertyType' },
                    { field: formData.price > 0, name: 'precio', element: 'propertyPrice' },
                    { field: formData.description, name: 'descripci√≥n', element: 'propertyDescription' },
                    { field: formData.location.address, name: 'direcci√≥n', element: 'propertyAddress' },
                    { field: formData.characteristics.area > 0, name: '√°rea', element: 'propertyArea' }
                ];

                for (let req of required) {
                    if (!req.field) {
                        alert(`‚ùå El campo "${req.name}" es requerido`);
                        document.getElementById(req.element).focus();
                        return false;
                    }
                }

                if (formData.images.length === 0) {
                    alert('‚ùå Debes agregar al menos una imagen URL v√°lida');
                    return false;
                }

                return true;
            }

            async initializeLocationMap() {
                try {
                    this.locationMap = L.map('locationMap').setView([18.7357, -70.1627], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(this.locationMap);

                    this.locationMarker = L.marker([18.7357, -70.1627])
                        .addTo(this.locationMap)
                        .bindPopup('Ubicaci√≥n de la propiedad')
                        .openPopup();

                    this.locationMap.on('click', (e) => {
                        const { lat, lng } = e.latlng;
                        this.locationMap.removeLayer(this.locationMarker);
                        this.locationMarker = L.marker([lat, lng]).addTo(this.locationMap).bindPopup('Ubicaci√≥n seleccionada').openPopup();
                        document.getElementById('propertyLat').value = lat;
                        document.getElementById('propertyLng').value = lng;
                        document.getElementById('selectedCoordinates').textContent = `Lat: ${lat.toFixed(4)}, Lng: ${lng.toFixed(4)}`;
                    });
                } catch (error) {
                    console.error('Error inicializando mapa:', error);
                }
            }

            updateDashboard() {
                document.getElementById('totalProperties').textContent = this.properties.length;
                document.getElementById('availableProperties').textContent = this.properties.filter(p => p.status === 'disponible').length;
                document.getElementById('houseCount').textContent = this.properties.filter(p => p.type === 'casa').length;
                document.getElementById('apartmentCount').textContent = this.properties.filter(p => p.type === 'apartamento').length;
            }

            renderPropertiesList() {
                const container = document.getElementById('propertiesList');
                if (!container) return;

                if (this.properties.length === 0) {
                    container.innerHTML = `
                        <div class="no-properties">
                            <h3>üè† No hay propiedades registradas</h3>
                            <p>Agrega tu primera propiedad</p>
                            <button onclick="adminManager.showSection('add-property'); document.querySelector('.sidebar-menu a[href=\\'#add-property\\']').click()" class="btn-primary">
                                ‚ûï Agregar Primera Propiedad
                            </button>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.properties.map(property => `
                    <div class="property-item">
                        <div class="property-info">
                            <h3>${this.escapeHtml(property.title)}</h3>
                            <div class="property-meta">
                                <span class="price">$${this.formatPrice(property.price)}</span>
                                <span class="type">${this.getTypeLabel(property.type)}</span>
                                <span class="status ${property.status}">${property.status}</span>
                            </div>
                            <div class="property-address">
                                <span>üìç</span>
                                <span>${this.escapeHtml(property.location?.address || 'Direcci√≥n no disponible')}</span>
                            </div>
                            <div class="property-area">
                                <small>√Årea: ${property.characteristics?.area || '0'} m¬≤</small>
                            </div>
                        </div>
                        <div class="property-actions">
                            <button class="btn-edit" onclick="adminManager.editProperty(${property.id})">‚úèÔ∏è Editar</button>
                            <button class="btn-delete" onclick="adminManager.deleteProperty(${property.id})">üóëÔ∏è Eliminar</button>
                        </div>
                    </div>
                `).join('');
            }

            getTypeLabel(type) {
                const types = { 'casa': 'Casa', 'apartamento': 'Apartamento', 'oficina': 'Oficina', 'solar': 'Solar' };
                return types[type] || type;
            }

            editProperty(propertyId) {
                const property = this.properties.find(p => p.id === propertyId);
                if (!property) {
                    alert('‚ùå Propiedad no encontrada');
                    return;
                }

                this.editingProperty = property;
                
                // Llenar formulario
                document.getElementById('propertyTitle').value = property.title || '';
                document.getElementById('propertyType').value = property.type || '';
                document.getElementById('propertyPrice').value = property.price || 0;
                document.getElementById('propertyDescription').value = property.description || '';
                document.getElementById('propertyAddress').value = property.location?.address || '';
                document.getElementById('propertyLat').value = property.location?.lat || 18.7357;
                document.getElementById('propertyLng').value = property.location?.lng || -70.1627;
                document.getElementById('selectedCoordinates').textContent = `Lat: ${property.location?.lat || 18.7357}, Lng: ${property.location?.lng || -70.1627}`;
                document.getElementById('propertyBedrooms').value = property.characteristics?.bedrooms || 0;
                document.getElementById('propertyBathrooms').value = property.characteristics?.bathrooms || 0;
                document.getElementById('propertyArea').value = property.characteristics?.area || 100;
                document.getElementById('propertyParking').checked = property.characteristics?.parking || false;
                document.getElementById('propertyPool').checked = property.characteristics?.pool || false;
                document.getElementById('propertyGarden').checked = property.characteristics?.garden || false;

                // Mostrar im√°genes existentes
                if (property.images && property.images.length > 0) {
                    document.getElementById('imageUrls').value = property.images.join('\n');
                    this.updateImagePreviewFromUrls(property.images.join('\n'));
                }

                this.showSection('add-property');
                document.querySelector('.sidebar-menu a[href="#add-property"]').click();
                document.querySelector('.btn-submit').innerHTML = '<span id="submitText">üîÑ Actualizar Propiedad</span><span id="submitLoading" class="hidden loading-spinner"></span>';
            }

            async handleUpdateProperty(propertyId) {
                if (this.isLoading) return;
                
                try {
                    this.isLoading = true;
                    this.setSubmitButtonLoading(true);

                    const formData = this.getFormData();
                    if (!this.validateForm(formData)) return;

                    const { error } = await window.supabase
                        .from('properties')
                        .update(formData)
                        .eq('id', propertyId);

                    if (error) throw error;

                    alert('‚úÖ Propiedad actualizada exitosamente!');
                    await this.loadPropertiesFromSupabase();
                    this.resetForm();
                    this.showSection('properties');
                    
                } catch (error) {
                    alert('‚ùå Error: ' + error.message);
                } finally {
                    this.isLoading = false;
                    this.setSubmitButtonLoading(false);
                    this.editingProperty = null;
                }
            }

            async deleteProperty(propertyId) {
                if (confirm('¬øEst√°s seguro de que quieres eliminar esta propiedad?')) {
                    try {
                        const { error } = await window.supabase
                            .from('properties')
                            .delete()
                            .eq('id', propertyId);

                        if (error) throw error;

                        alert('üóëÔ∏è Propiedad eliminada exitosamente');
                        await this.loadPropertiesFromSupabase();
                    } catch (error) {
                        alert('‚ùå Error: ' + error.message);
                    }
                }
            }

            resetForm() {
                document.getElementById('propertyForm').reset();
                document.getElementById('imageUrls').value = '';
                document.getElementById('imagePreview').innerHTML = '';
                this.editingProperty = null;
                
                document.querySelector('.btn-submit').innerHTML = '<span id="submitText">üè† Agregar Propiedad</span><span id="submitLoading" class="hidden loading-spinner"></span>';
                
                // Resetear mapa
                if (this.locationMarker) {
                    this.locationMap.removeLayer(this.locationMarker);
                    this.locationMarker = L.marker([18.7357, -70.1627]).addTo(this.locationMap).bindPopup('Ubicaci√≥n de la propiedad');
                    document.getElementById('propertyLat').value = 18.7357;
                    document.getElementById('propertyLng').value = -70.1627;
                    document.getElementById('selectedCoordinates').textContent = 'Lat: 18.7357, Lng: -70.1627';
                }
            }

            setSubmitButtonLoading(loading) {
                const submitText = document.getElementById('submitText');
                const submitLoading = document.getElementById('submitLoading');
                const submitBtn = document.querySelector('.btn-submit');
                
                submitBtn.disabled = loading;
                if (loading) {
                    submitText.classList.add('hidden');
                    submitLoading.classList.remove('hidden');
                } else {
                    submitText.classList.remove('hidden');
                    submitLoading.classList.add('hidden');
                }
            }

            formatPrice(price) {
                return new Intl.NumberFormat('es-DO').format(price || 0);
            }

            escapeHtml(unsafe) {
                if (!unsafe) return '';
                return unsafe
                    .replace(/&/g, "&amp;")
                    .replace(/</g, "&lt;")
                    .replace(/>/g, "&gt;")
                    .replace(/"/g, "&quot;")
                    .replace(/'/g, "&#039;");
            }
        }

        // INICIALIZAR
        document.addEventListener('DOMContentLoaded', () => {
            window.adminManager = new AdminManager();
            window.adminManager.init();
        });
    </script>
</body>
</html>