<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inmobiliaria Moderna</title>
    <link rel="stylesheet" href="css/client.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Bot√≥n flotante admin -->
    <div class="admin-floating-btn">
        <button id="adminAccessBtn" title="Acceso Administrador">‚öôÔ∏è Admin</button>
    </div>

    <!-- Modal admin -->
    <div id="adminModal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üîí Acceso Administrador</h3>
                <button class="close-modal" id="closeAdminModal">√ó</button>
            </div>
            <div class="modal-body">
                <input type="password" id="adminPassword" placeholder="Contrase√±a de administrador">
                <div class="modal-buttons">
                    <button id="cancelAdminBtn" class="btn-secondary">Cancelar</button>
                    <button id="submitAdminBtn" class="btn-primary">Acceder</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal propiedad -->
    <div id="propertyModal" class="modal hidden">
        <div class="modal-content property-modal">
            <div class="modal-header">
                <h3 id="modalPropertyTitle">Propiedad</h3>
                <button class="close-modal" id="closePropertyModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="property-gallery">
                    <div class="main-image">
                        <img id="mainPropertyImage" src="" alt="Imagen principal">
                    </div>
                    <div class="image-thumbnails" id="propertyThumbnails">
                        <!-- Miniaturas aqu√≠ -->
                    </div>
                </div>
                <div class="property-details">
                    <div class="price-section">
                        <span class="price" id="modalPropertyPrice">$0</span>
                        <span class="type-badge" id="modalPropertyType">Casa</span>
                    </div>
                    <div class="address" id="modalPropertyAddress">
                        <span>üìç</span>
                        <span>Direcci√≥n no disponible</span>
                    </div>
                    <div class="features">
                        <div class="feature">
                            <span>üõèÔ∏è</span>
                            <span id="modalBedrooms">0</span>
                            <span>hab.</span>
                        </div>
                        <div class="feature">
                            <span>üöø</span>
                            <span id="modalBathrooms">0</span>
                            <span>ba√±os</span>
                        </div>
                        <div class="feature">
                            <span>üìê</span>
                            <span id="modalArea">0</span>
                            <span>m¬≤</span>
                        </div>
                    </div>
                    <div class="description">
                        <h4>Descripci√≥n</h4>
                        <p id="modalPropertyDescription">Descripci√≥n no disponible.</p>
                    </div>
                    <div class="contact-section">
                        <button class="btn-contact">üìû Contactar Agente</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Header Moderno -->
    <header class="modern-header">
        <div class="header-container">
            <div class="logo">
                <h1>üè† Inmobiliaria Elite</h1>
            </div>
            <nav class="main-nav">
                <a href="#properties">Propiedades</a>
                <a href="#about">Nosotros</a>
                <a href="#contact">Contacto</a>
            </nav>
        </div>
    </header>

    <!-- Hero Section -->
    <section class="hero">
        <div class="hero-content">
            <h2>Encuentra tu hogar ideal</h2>
            <p>Las mejores propiedades en las ubicaciones m√°s exclusivas</p>
        </div>
    </section>

    <!-- Filtro Principal -->
    <section class="filter-section">
        <div class="container">
            <div class="filter-main-btn" id="mainFilterBtn">
                <span class="filter-icon">üèòÔ∏è</span>
                <span class="filter-text">Propiedades Disponibles</span>
                <span class="filter-arrow">‚ñº</span>
            </div>
            <div class="filter-options hidden" id="filterOptions">
                <div class="filter-option" data-filter="all">
                    <span class="option-icon">üèòÔ∏è</span>
                    <span class="option-text">Todas las Propiedades</span>
                </div>
                <div class="filter-option" data-filter="casa">
                    <span class="option-icon">üè†</span>
                    <span class="option-text">Casas</span>
                </div>
                <div class="filter-option" data-filter="apartamento">
                    <span class="option-icon">üè¢</span>
                    <span class="option-text">Apartamentos</span>
                </div>
                <div class="filter-option" data-filter="oficina">
                    <span class="option-icon">üèõÔ∏è</span>
                    <span class="option-text">Oficinas</span>
                </div>
                <div class="filter-option" data-filter="solar">
                    <span class="option-icon">üìê</span>
                    <span class="option-text">Solares</span>
                </div>
            </div>
        </div>
    </section>

    <!-- Mapa Interactivo -->
    <section class="map-section">
        <div class="container">
            <h3 class="section-title">üìç Ubicaci√≥n de Propiedades</h3>
            <div id="map"></div>
        </div>
    </section>

    <!-- Lista de Propiedades -->
    <section class="properties-section" id="properties">
        <div class="container">
            <div class="section-header">
                <h3 class="section-title" id="propertiesTitle">Todas las Propiedades</h3>
                <div class="properties-count">
                    <span id="propertiesCount">0</span> propiedades encontradas
                </div>
            </div>
            <div class="properties-grid" id="propertiesGrid">
                <div class="loading">Cargando propiedades...</div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="modern-footer">
        <div class="container">
            <p>&copy; 2024 Inmobiliaria Elite. Todos los derechos reservados.</p>
        </div>
    </footer>

    <!-- SCRIPTS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script>
        // CONFIGURACI√ìN SUPABASE
        const SUPABASE_URL = 'https://vbimfwzxdafuqexsnvso.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZiaW1md3p4ZGFmdXFleHNudnNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM3NTY4NDksImV4cCI6MjA3OTMzMjg0OX0.8ergS1GXQm6L0Om6AZReeTK0e3Q81k-UQSVJAu3xMNQ';
        
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // CLIENT MANAGER COMPLETO
        class ModernClientManager {
            constructor() {
                this.properties = [];
                this.filteredProperties = [];
                this.currentFilter = 'all';
                this.map = null;
                this.markers = [];
            }

            init() {
                this.setupEventListeners();
                this.initializeMap();
                this.loadProperties();
            }

            setupEventListeners() {
                // BOT√ìN ADMIN - YA FUNCIONA
                const adminBtn = document.getElementById('adminAccessBtn');
                if (adminBtn) {
                    adminBtn.addEventListener('click', () => {
                        this.showAdminModal();
                    });
                }

                // MODAL ADMIN
                const closeAdmin = document.getElementById('closeAdminModal');
                const cancelAdmin = document.getElementById('cancelAdminBtn');
                const submitAdmin = document.getElementById('submitAdminBtn');

                if (closeAdmin) closeAdmin.addEventListener('click', () => this.hideAdminModal());
                if (cancelAdmin) cancelAdmin.addEventListener('click', () => this.hideAdminModal());
                if (submitAdmin) submitAdmin.addEventListener('click', () => this.handleAdminLogin());

                // FILTROS
                const mainFilterBtn = document.getElementById('mainFilterBtn');
                if (mainFilterBtn) {
                    mainFilterBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const filterOptions = document.getElementById('filterOptions');
                        if (filterOptions) filterOptions.classList.toggle('hidden');
                    });
                }

                const filterOptions = document.querySelectorAll('.filter-option');
                filterOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const filter = option.getAttribute('data-filter');
                        this.applyFilter(filter);
                        
                        // Actualizar UI del filtro activo
                        filterOptions.forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                        
                        // Actualizar texto del bot√≥n principal
                        const optionText = option.querySelector('.option-text').textContent;
                        document.querySelector('.filter-text').textContent = optionText;
                        
                        // Ocultar dropdown
                        document.getElementById('filterOptions').classList.add('hidden');
                    });
                });

                // Cerrar dropdown al tocar fuera
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.filter-section')) {
                        const filterOptions = document.getElementById('filterOptions');
                        if (filterOptions) filterOptions.classList.add('hidden');
                    }
                });

                // BOT√ìN CONTACTAR
                const contactBtn = document.querySelector('.btn-contact');
                if (contactBtn) {
                    contactBtn.addEventListener('click', () => {
                        alert('üìû Un agente se pondr√° en contacto contigo pronto.');
                    });
                }
            }

            showAdminModal() {
                const modal = document.getElementById('adminModal');
                if (modal) {
                    modal.classList.remove('hidden');
                }
            }

            hideAdminModal() {
                const modal = document.getElementById('adminModal');
                if (modal) modal.classList.add('hidden');
            }

            handleAdminLogin() {
                const password = document.getElementById('adminPassword').value;
                if (password) {
                    window.location.href = 'admin.html';
                } else {
                    alert('Por favor ingresa una contrase√±a');
                }
            }

            initializeMap() {
                try {
                    this.map = L.map('map').setView([18.7357, -70.1627], 8);
                    
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OpenStreetMap contributors'
                    }).addTo(this.map);
                    
                    console.log('‚úÖ Mapa inicializado');
                } catch (error) {
                    console.error('‚ùå Error con mapa:', error);
                }
            }

            async loadProperties() {
                try {
                    // Intentar cargar de Supabase
                    const { data: properties, error } = await window.supabase
                        .from('properties')
                        .select('*')
                        .eq('status', 'disponible')
                        .order('created_at', { ascending: false });

                    if (error) throw error;

                    if (properties && properties.length > 0) {
                        this.properties = properties;
                        console.log(`‚úÖ ${properties.length} propiedades cargadas de Supabase`);
                    } else {
                        // Cargar propiedades de ejemplo
                        this.loadExampleProperties();
                    }
                } catch (error) {
                    console.error('Error cargando propiedades:', error);
                    this.loadExampleProperties();
                }

                this.filteredProperties = [...this.properties];
                this.renderProperties();
                this.updatePropertiesCount();
                this.renderMapMarkers();
            }

            loadExampleProperties() {
                this.properties = [
                    {
                        id: 1,
                        title: "Hermosa Casa Familiar con Piscina",
                        type: "casa",
                        price: 350000,
                        location: {
                            address: "Calle Principal #123, Santo Domingo Este",
                            lat: 18.4855,
                            lng: -69.8731
                        },
                        characteristics: {
                            bedrooms: 4,
                            bathrooms: 3,
                            area: 220,
                            parking: true,
                            pool: true,
                            garden: true
                        },
                        description: "Impresionante casa familiar ubicada en una zona residencial exclusiva. Cuenta con amplios espacios, dise√±o moderno y √°reas verdes.",
                        images: [
                            "https://images.unsplash.com/photo-1613490493576-7fde63acd811?w=600",
                            "https://images.unsplash.com/photo-1600596542815-ffad4c1539a9?w=600"
                        ],
                        status: "disponible",
                        created_at: new Date().toISOString()
                    },
                    {
                        id: 2,
                        title: "Apartamento de Lujo en Torre Moderna",
                        type: "apartamento",
                        price: 185000,
                        location: {
                            address: "Av. George Washington #456, Malec√≥n",
                            lat: 18.4735,
                            lng: -69.8904
                        },
                        characteristics: {
                            bedrooms: 2,
                            bathrooms: 2,
                            area: 95,
                            parking: true,
                            pool: true,
                            garden: false
                        },
                        description: "Elegante apartamento en torre de lujo con vista al mar. Incluye amenities premium: gimnasio, piscina infinity y seguridad 24/7.",
                        images: [
                            "https://images.unsplash.com/photo-1545324418-cc1a3fa10c00?w=600",
                            "https://images.unsplash.com/photo-1484154218962-a197022b5858?w=600"
                        ],
                        status: "disponible",
                        created_at: new Date().toISOString()
                    }
                ];
                console.log('‚úÖ Propiedades de ejemplo cargadas');
            }

            applyFilter(filter) {
                this.currentFilter = filter;
                
                if (filter === 'all') {
                    this.filteredProperties = [...this.properties];
                } else {
                    this.filteredProperties = this.properties.filter(property => 
                        property.type === filter
                    );
                }
                
                this.renderProperties();
                this.updatePropertiesCount();
                this.renderMapMarkers();
            }

            updatePropertiesCount() {
                const countElement = document.getElementById('propertiesCount');
                const titleElement = document.getElementById('propertiesTitle');
                
                if (countElement) {
                    countElement.textContent = this.filteredProperties.length;
                }
                
                if (titleElement) {
                    const filterLabels = {
                        'all': 'Todas las Propiedades',
                        'casa': 'Casas',
                        'apartamento': 'Apartamentos',
                        'oficina': 'Oficinas',
                        'solar': 'Solares'
                    };
                    titleElement.textContent = filterLabels[this.currentFilter] || 'Propiedades';
                }
            }

            renderProperties() {
                const container = document.getElementById('propertiesGrid');
                if (!container) return;

                if (this.filteredProperties.length === 0) {
                    container.innerHTML = `
                        <div class="no-properties" style="grid-column: 1/-1; text-align: center; padding: 60px; color: #64748b;">
                            <h3>üè† No hay propiedades disponibles</h3>
                            <p>Intenta con otros filtros de b√∫squeda</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = this.filteredProperties.map(property => `
                    <div class="property-card" onclick="clientManager.showPropertyDetails(${property.id})">
                        <div class="property-image">
                            <img src="${property.images[0]}" alt="${property.title}">
                            <div class="property-badge">${this.getTypeLabel(property.type)}</div>
                        </div>
                        <div class="property-info">
                            <h3>${property.title}</h3>
                            <div class="property-price">$${property.price.toLocaleString()}</div>
                            <div class="property-address">
                                <span>üìç</span>
                                <span>${property.location.address}</span>
                            </div>
                            <div class="property-features-preview">
                                ${property.characteristics.bedrooms > 0 ? `<span>üõèÔ∏è ${property.characteristics.bedrooms} hab.</span>` : ''}
                                ${property.characteristics.bathrooms > 0 ? `<span>üöø ${property.characteristics.bathrooms} ba√±os</span>` : ''}
                                <span>üìê ${property.characteristics.area} m¬≤</span>
                            </div>
                            <button class="view-details-btn">Ver Detalles</button>
                        </div>
                    </div>
                `).join('');
            }

            renderMapMarkers() {
                if (!this.map) return;

                // Limpiar marcadores anteriores
                this.markers.forEach(marker => this.map.removeLayer(marker));
                this.markers = [];

                this.filteredProperties.forEach(property => {
                    if (property.location && property.location.lat && property.location.lng) {
                        const customIcon = L.divIcon({
                            html: `<div style="background: #2563eb; color: white; padding: 8px; border-radius: 50%; font-size: 16px; border: 2px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);">üè†</div>`,
                            className: 'property-marker',
                            iconSize: [40, 40]
                        });

                        const marker = L.marker([property.location.lat, property.location.lng], { icon: customIcon })
                            .addTo(this.map)
                            .bindPopup(`
                                <div style="min-width: 200px;">
                                    <img src="${property.images[0]}" alt="${property.title}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px;">
                                    <h4 style="margin: 8px 0; font-size: 14px;">${property.title}</h4>
                                    <p style="margin: 4px 0; font-weight: bold; color: #2563eb;">$${property.price.toLocaleString()}</p>
                                    <button onclick="clientManager.showPropertyDetails(${property.id})" 
                                            style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; width: 100%; margin-top: 8px;">
                                        Ver Detalles
                                    </button>
                                </div>
                            `);
                        
                        this.markers.push(marker);
                    }
                });

                if (this.markers.length > 0) {
                    const group = new L.featureGroup(this.markers);
                    this.map.fitBounds(group.getBounds().pad(0.1));
                }
            }

            showPropertyDetails(propertyId) {
                const property = this.properties.find(p => p.id === propertyId);
                if (property) {
                    this.updatePropertyModal(property);
                    this.showPropertyModal();
                }
            }

            updatePropertyModal(property) {
                document.getElementById('modalPropertyTitle').textContent = property.title;
                document.getElementById('modalPropertyPrice').textContent = `$${property.price.toLocaleString()}`;
                document.getElementById('modalPropertyType').textContent = this.getTypeLabel(property.type);
                document.getElementById('modalPropertyAddress').querySelector('span:last-child').textContent = property.location.address;
                document.getElementById('modalPropertyDescription').textContent = property.description;
                document.getElementById('modalBedrooms').textContent = property.characteristics.bedrooms;
                document.getElementById('modalBathrooms').textContent = property.characteristics.bathrooms;
                document.getElementById('modalArea').textContent = property.characteristics.area;

                // Galer√≠a de im√°genes
                const mainImage = document.getElementById('mainPropertyImage');
                const thumbnailsContainer = document.getElementById('propertyThumbnails');

                if (property.images && property.images.length > 0) {
                    mainImage.src = property.images[0];
                    
                    thumbnailsContainer.innerHTML = property.images.map((image, index) => `
                        <div class="thumbnail ${index === 0 ? 'active' : ''}" data-image="${image}">
                            <img src="${image}" alt="Miniatura ${index + 1}">
                        </div>
                    `).join('');

                    thumbnailsContainer.querySelectorAll('.thumbnail').forEach(thumb => {
                        thumb.addEventListener('click', () => {
                            const imageSrc = thumb.getAttribute('data-image');
                            mainImage.src = imageSrc;
                            thumbnailsContainer.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                            thumb.classList.add('active');
                        });
                    });
                }
            }

            showPropertyModal() {
                document.getElementById('propertyModal').classList.remove('hidden');
            }

            getTypeLabel(type) {
                const types = {
                    'casa': 'Casa',
                    'apartamento': 'Apartamento',
                    'oficina': 'Oficina',
                    'solar': 'Solar'
                };
                return types[type] || type;
            }
        }

        // INICIALIZAR APLICACI√ìN
        document.addEventListener('DOMContentLoaded', function() {
            window.clientManager = new ModernClientManager();
            window.clientManager.init();
        });
    </script>
</body>
</html>